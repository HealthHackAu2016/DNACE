<!doctype html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7" lang=""> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8" lang=""> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9" lang=""> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang=""> <!--<![endif]-->
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>DNACE - dance to DNA</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="apple-touch-icon" href="apple-touch-icon.png">
        <link rel="stylesheet" href="css/bootstrap.min.css">
        <link rel="stylesheet" href="css/bootstrap-theme.min.css">
        <link rel="stylesheet" href="css/main.css">
        <script src="js/vendor/modernizr-2.8.3-respond-1.4.2.min.js"></script>
		<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
        <script>window.jQuery || document.write('<script src="js/vendor/jquery-1.11.2.min.js"><\/script>')</script>
        <script src="js/vendor/jquery.transit.min.js"></script>
        <script src="js/vendor/bootstrap.min.js"></script>
        <script src="js/vendor/velocity.js"></script>
        <script src="js/vendor/jquery.color.js"></script>
        <script src="js/main.js"></script>
		<script src="https://code.createjs.com/soundjs-0.6.2.min.js"></script>
		<script type="text/javascript">
			var genomes = {
				genome1:'GTCCTGATTGCTGATTTCTTTGACTTTCCCCATCACACTATTAATTTCTACCATATTAATCACTTTATAATCTCCTTTCCTAACCGCTTCTGAATCTCGAACCGCAACCGGGCGGGGTAAGTATGAGTGCCTTAACCACCTATACTAATATGTAGTACCCTATCACTCCTACACGACGATTTTGCGATATTCGGAGCTTTCTTTGACTAGGTTGTACCACATTGTTGAAGAATGGATGTTGTCAATGTTACGATCTCTTCAGACATCTCCGAACGCGCTTTCGAATATAGTGTCTTTATAAATCCTGAGGTGAATTCCAGGAATATATTCATTTTACGACCACGTGTTCACGCGTTATAGACTTCTTTGGGTCTGTTCTTAGCTTCACAACACGCAAGTCTCTCATTGGTTATTAATTTCCATGGCCATTTAAGCAGGCTTTTTCTAGACCTAAAATAAGGTAAGTACAATTCAACTCCCTTAAATGGGAAGTTATCCTGTATGTCTACGTCCAATACTCTGTCGTCAATTTCAATGGAGAATCCCACGAATCATCCAATGTGTAAAGTAAATTACGTTACTCCCGTAAAGTAGTATATCTCCGAGTCCGCATTAAGTGAAATCAAGATTAAAAGAGGCTAAATAACTTTATTAAGGTCTGAAATATGTGCAACCATTTCTCCACCACTCCAAAATTGATTTTATCAACTATATTTTCTTAACAACGTCAGCTTTAAGATATTATCGATGACGGAGAAGTTCACCATGAATATGAAACCCATTTTACTCCTATTCCAACTTTTACCATAACGTTCCTGACTCCTACTTTTAACCGGCCCTCATGAAATTGTTACTATTCCGTAAATTTTAGATAGTTCATAATATCCTTATTCCTCTTAAAGGCGGGCTACAAGTATATTAGGTCGTTCCCGTTATCCTGAAATCACTGTCTCCTCGGACTTTTCCCCTTCTCCCGACTGAATTAGCATTACCTACTTTCATCCACAATTTTCGACATATTTACCTCTCCTCTAAAAAGATCGTCGATCGTTTCTTCACAAAGTTGATTCTTAATCAAAGTGCTAAAAGAAGTCTAGACCATATCTACAGAATAGCCTCAACATTTAAAACTTTCCTATAATTCAATAGTTTGTTATCTTTTACGAAATAAATCAAACCCGCAATTACCCTGGAAGTTTTATATCTATAATAGAAGGCCCTCTGTAAAATAACCGATTTTTCTCAAACTTTTTCTGTAAACCAAGATTAAATAACTATGACTTCTTTAATATCTACTCAGAAGTTTTCGAGGAATGAATCAAAGTGGATAAGAAGTTTTACCCATTTTCTTAAACCGCAGGACATGCTAGACTTCTACTCTTACTGTAACTTATGCGATGATTCAAACATCGTTTAGCATAAGGAATAGCAGTGGCCGACCATGAAGTTGTTAACCAGTTCAAATGGATAAAAGGGAGTTATCAACAACTATAAGTCTTTAACTTATTTCATAACCTTGAACTACCTCTGGAAAAATTTTATAGAGGACCGCAATTTCGCAAAACGTTTCGTGAAATTAATGATATCTTTTCCTTTCTAGCAATTCGATATAGCAGTCATGAAAGATATAGATGTAATCCTGGGATCAACGGCCAGGGTAACCTCGTAATCTAGAATAGTTAAAAGTAGGTAAAATACCATTATAGAGTCTGCGCATTTTTATCATCTAGCAGGATCTGAGAGTTCGTCCTTGAATGACGGGTACTGAAATCGGCAAACGAGTTCATAAGTACAGTAACCTTAATTGACTCCGGGTTCAACAATAACTAATACTTCTGACCTTTCTACCAATCAATCGGGCAAGTTATTGCAGTCACTTCCATCAATTCAAGATCTTAAGTTTTGTCTTTATCAAACCCAAGCCTATATCAGCTTATCCGCATCTCCCCGAAACCGAAACCAGAGAGTTCAGGCAATTTGGCTTTCACATAGTACACATATACGCGTTCGTACTTTTCAAAACCTTCTTCATTTATACTCCAAAGTGCTTAATCGTAAGCGTCGTTAAATGCACTATCCATTCAAGTGATCTAAAGGTTTGACACGCCGTGGCCCGTGACAACGATGGAGATTTACAAAGGCAAACATGCCAGTTTATTTCTTCGAAGTCCAAGTTTGCGACGATTGCGTATTGCCCTACAATACGAACCCACTTTGCCTATTAGATATGACATAAGTACAGTCGATTCGTTATAGCTTGATTATCCAGCGCTTACTATTTCCCCATATGTAAATTTACTGTAAGGAGTCATCAGGTCCTATACAACTATATCATTATATCTACTCTTATTAATTACCTATTTTGATTCTTTACCAACTAGGCGTACTATACAATTAGGTCTTACGGTCAGACCTATCGGCTTTCAAGACCCATACCGATCACCCAAATTAGATTTTCGTGACCTGTGAGTGGTTTCTCGCTGACTTTTATTCGCGATTTATCCCTTGGCATATGTCGAGATACCAAGGAATATAGATTCAGGTAATTTCCATACTCCATTCGCCCTTCCGTAGCCCCACTGTAAATTCTAATCCTCGTTATGTTACCACATTACGTTTAGGTTTATGG',
				genome2:'TGTTTCTGTTGGTGCCTGGGTTGCTCTTTCTTTGGGTTTCTCAGAAACGCCTATTAATTTCTACCGACTTAATCACCTTTATAATCCTTTCCCTGCTCCCCCTTCTGAATCTCCGGGCCGAGAATGAAAATCCCGAAATAGACAGTATGAGTATTAAATCTGATACACCTAGACCACAATATGACATGGGCCAATATCACTCCACCCCCTATGATTTTGCGATATGAGATTTCTTTGACGATTGACACGGTGTCCCAGGATGGATGTTGTCAATGTCAGAGATCTCTTCAGGGTGGCGAACGGAGCTTTTCGAATATAGTGTCTTTAGCGCGCTTGAGTAGCGGGCGTTGCCAGGAATATATTCATTTTACGACCACGTGTTCACGATTCACTATATTCTTTGGGTCTTTCTTGACATTGTGCCAACTACCGCCCAGTCTCTCATTGGTGTGTATGCGTTTCGAACGCGCGTCGCAGGCTTTTTTCCCAACCCCCCGCCTCAGGTAAGTGAATTCAACTCCCTTAAGTACGGGAAGTCTGGTATCTACGTATGTCAACTCCGTCTAATACTCTGTCGTCGATTTCGTAGGAGAATCCCACAGAATCAAACCGATGTAAAAAGGCCACGTGGCTTTACTCCCGTAAAAGTAATATCTCCGGTGCCCGCATGCCAATCGAGTCGCTAATGCCACGGAATAAAGGTAATTATGCCAATCTGAAATATGTGCATACGTTTGTCACGCGCCGACCCAAGGTTAATTTTATCGACTGACGGACTTTTCTTAACGGCTTCGACGTCTAAGCTCTGTAAAGATGACGAGAAGTTCACCGGGCATGAAACCCATTTTAACACACTTCCGACTTTTGTAGCATAACGTTCCTGGGCCCTACTTTTAACCGGACCCTCATGAAATTGTTATAATTCATGGTTTTAAAACGTCAGCTGGTGCTTATTTAATAAGGCGAAATCATACTAAGTATATTAGTCGTTCCAGTTTTATCCTCCAATCACTGTCTCCCTACTTTTCCTAAGTCTCGAGACCCGATTCGCATTACCACCTTCATCCGGATATTTTTTCACACTTTACCTCTCAGCCCCGCCGATCGGTCAATCTCTCGTTCTTCCATTGACTTAATCAAAAAGTGCTAAAAGGGAGTCGCACTCAAAATGACGAATCACCTACATTTACATCTTTCTAGCGTTAAATAGTTTGTTATCTTTTACGAGAACGGTAGAGTATCCCGCAGTTACAATGAAGTTTTATATCTATAAAAACGAGACTACCTCTGTAAAATAACGAATTTTTTGTGTGCTCAATATTTTTCTGTAAGTATAGCGAGATTAAATAACTATGACTTCTTTAAAACTAGCACAAGTTTTCCAGGAATGAATCAGATCAGCCGAAGTTTTACCCATTTTCTTAGATACAGAGGGGCCATGCCGCTATTACCTCTTAGTGACTTATGCAGGCTTTTCGGGCTCGTTTAGCATAAGGAACACTGAGCGATCTCGGAGCATGAATTGTGTCTCTGAAGTTCGAACAGGTAAGGGAGTTATCAACAACTAGCGGTTATTTAGACTTATTTCATAACCTTGGGACTCTCTATAGTGCAAAATTTTATAGAGATAGAAGATTTCGCACTCCGTTCGTGAAATTAATGATATCTTTTCCTTTCCTCAATTCGGACGCGTAATACGCAAAAAATATAATGTAATCCTCCAGTAACGGCTAGACTATAATGATCGCGGCTTTAAAAGTAAGCTGCGCTGGGATCTACAAGTTAACTTAGGGTTTTTTGGTAATACACACAGGATCTGAGAGTTCGTGATTATGCGTAACTATACTGAAGATCAACGAAAACGAATTCAGCCCTGATACTTAGATTGTAACTCCACGACTTCATCAGCGCTACTCGATGATTTAACCTTTCTCGCCGTAATCGGGCAAGTTATTGCAGTCAATTCAGAATAATTCAGATCTTAAGTTTTGTCTTTATCAATATCGCGGCCTATATCATATTATCCGCATGGCCCGAAACCGAAACCGAGAGTTCGATCCAATTGGCTTTCGCTTCACATCACGTTCGTACTTTTCAAAGCTACTTCTTCATTTATACTCCGACACTTATGCTTAATCATCGTAAGCGTCGTTAAATGCACTATGGATTCAGTCGTACTCCGCGCTGTTACTCGCCGCCAATTATCTCCAGTCAAGCGATGGGAGATTTATGCTAGGTAGAGGCTGCCAGTTCTTTCGTTGGAAATCAGGACAGTTTGCGACGATTGCAGATCTGCCCACCAATGACGGCATTCCCACACTTTGCTATTAATATGACATAAGTGACAGTCAATTCGTTATAGCCTTGATTATCCGACATTACACTTTCGGACGGGGCGACTATCGACTTTATGTAGGAACCGCTTCACTGACCAACTACTCCTTATATCTCTCTTATTAGTGCCCTTTTGATTCTTTACCAACAGGCGTACTATAATTAGTCCCCTTCAACTATCGACCGTCCGCTCCATACGATCGCGGTATTATCATTTCCTGATCTCTATTGAGTGGTTTCTCGCGTATTTTATTCCAATTTAACATTAATAATGTCGAGACTCACAAGGAATATAATTCAGGTATTTCACACCTCCATTCCACTTCCTGACCGCCGGGTCATTCGCGTGAGCGTTATGTCGCCCGTGAGCTTTCTGTTATGTTTCTGCTCTACTTG'
			};

			var currentGenome, currentPointInGenome, currentLetter, speedLimiter, speedCounter, elements, currentScore, currentMisses;

			var gameClock;
			var gameState;

			var playPerLetter = false;

			var bodyHeight = 0;

			var aKey = 37; //left
			var tKey = 38; //up
			var gKey = 40; //right
			var cKey = 39; //down
			var tolerance = 50; //tolerance in pixels... higher tolerance number is easier
			var codeLimit = 6*6;

			$(document).ready( function() {
				//load assets
				createjs.Sound.registerSound("assets/genome1.mp3", "genome1");
				createjs.Sound.registerSound("assets/genome2.mp3", "genome2");
				//createjs.Sound.registerSound("assets/gamestart.mp3", "gamestart");
				createjs.Sound.registerSound("assets/good.mp3", "good");
				createjs.Sound.registerSound("assets/bad.mp3", "bad");
				createjs.Sound.registerSound("assets/a.mp3", "a");
				createjs.Sound.registerSound("assets/g.mp3", "g");
				createjs.Sound.registerSound("assets/t.mp3", "t");
				createjs.Sound.registerSound("assets/c.mp3", "c");
				//createjs.Sound.registerSound("assets/win.mp3", "win");
				//createjs.Sound.registerSound("assets/lost.mp3", "lose");
				//restartGame();
			});

			function killGame() {
				if (gameClock != undefined) {
					window.clearInterval(gameClock);
					$('body').off();
					for(i in elements) {
						elements[i].stop();
						elements[i].remove();
					}
					createjs.Sound.stop();
					//TODO play fail here...
					$('.message').html('Too many errors - retry');
				}
			}

			function restartGame(genome) {
				killGame();
				initGame(genome);
			}

			function initGame(genome) {
				//set init vars here
				bodyHeight = 0;
				currentScore = 0;
				currentMisses = 0;
				currentGenome = genomes[genome];
				currentPointInGenome = 0;
				currentLetter = '';
				speedLimiter = 10;
				speedCounter = 0;
				elements = [];

				//set score
				$('.score .numbers').html('0');
				$('.score .code').empty();
				$('.score .misses .block').animate({backgroundColor:'#444'});
				$('.message').html('Sequencing...');

				//setup key handlers
				setupKeyHandlers();

				//createjs.Sound.play('gamestart'); //this needs to be ready...

				//TODO add start animation???
				createjs.Sound.play(genome);
				var soundStart = window.setTimeout(function() {
					nextTick();
					gameClock = window.setInterval(nextTick, 500); //start game loop, run every 100ms
				}, 250);
			}

			function setupKeyHandlers() {
				$('body').keyup(function(e) {
					console.log('keypress ' + e.which);
					if (e.which == aKey) {
						handleKeypress('A');
					} else if (e.which == gKey) {
						handleKeypress('G');
					} else if (e.which == tKey) {
						handleKeypress('T');
					} else if (e.which == cKey) {
						handleKeypress('C');
					}
				});
			}

			function withinTolerance(elem, hitbox) {
				var diff = hitbox.position().top - elem.position().top;
				console.log(diff);
				if ( tolerance > diff && diff < tolerance) {
					return true;
				} else return false;
			}

			function handleKeypress(letter) {
				var hitbox = $('.hit-'+letter.toLowerCase());
				var success = false;

				//check for successful hit
				for (i in elements) {
					var elem = elements[i];
					if (elem.attr('type') == letter && withinTolerance(elem, hitbox)) {

						success = true;
						currentScore++;
						$('.score .numbers').html(currentScore);

						var scoreBlock = elem.clone();
						scoreBlock.attr('id',guid()); //reset the guid to prevent mixup...
						scoreBlock.css({top:'auto'}); //reset the guid to prevent mixup...
						var code = $('.score .code');
						code.prepend(scoreBlock);
						if (code.children().length > codeLimit) code.children().last().remove();

						//stop the animation and remove element
						elem.stop();
						removeFromElements(elem.get());
						$(elem).stop().animate(
							{backgroundColor:'green', opacity:0}, 100, function() {this.remove();}
						);

						createjs.Sound.play('good');
					}
				}

				//hitbox animation
				var backgroundColor = '#444';
				if (success) backgroundColor = 'green';
				$(hitbox).stop().animate(
					{backgroundColor:backgroundColor}, 100,
					function() {$(this).animate({backgroundColor:'transparent'}, 100);}
				);
			}

			function removeFromElements(domElem) {
				for (i in elements) {
					if (elements[i].attr('id') == $(domElem).attr('id')) {
						elements.splice(i,1);
						break;
					}
				}
			}

			function getBlockHtmlForLetter(letter) {
				return '<div id="'+guid()+'" class="block" type="'+letter+'">'+letter+'</div>';
			}

			function nextTick() {
				//TODO check the speed limiter/counter to generate blocks

				//read in the next bit in the currentGenome
				if (currentPointInGenome < currentGenome.length) {
					currentPointInGenome++;
				} else {
					currentPointInGenome = 0;
				}
				currentLetter = currentGenome.charAt(currentPointInGenome);

				//generate the block and animate downwards
				var bodyHeight = $('body').height();
				var newBlock = $(getBlockHtmlForLetter(currentLetter));
				$('.col-'+currentLetter.toLowerCase()).append(newBlock);
				$(newBlock).animate({
				    top:bodyHeight + 'px'
				}, 5000, 'linear', function() {
					handleMiss(this);
				});
				elements.push(newBlock); //store it in the master array for easy access later

				if (playPerLetter) createjs.Sound.play(currentLetter.toLowerCase());
			}

			function handleMiss(elem) {
				removeFromElements(elem);
				$(elem).stop().animate(
					{backgroundColor:'red', top:'-=20', left:'-=20', width:'+=40', height:'+=40'}, 100,
					function() {
						$(this).animate({opacity:0}, 100, function(){ this.remove(); });
					}
				);

				currentMisses++;
				if (currentMisses < 7) {
					$('.misses .block:nth-child('+currentMisses+')').animate({backgroundColor:'red'});
					var missBlock = '<div class="block error"></div>';
					var code = $('.score .code');
					code.prepend(missBlock);
					if (code.children().length > codeLimit) code.children().last().remove();
				} else {
					killGame();
				}

				createjs.Sound.play('bad');
			}

			function guid() {
			    var d = new Date().getTime();
			    var uuid = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
			        var r = (d + Math.random()*16)%16 | 0;
			        d = Math.floor(d/16);
			        return (c=='x' ? r : (r&0x3|0x8)).toString(16);
			    });
			    return uuid;
			};

			function toggleSound() {}
		</script>
    </head>
    <body>
        <!--[if lt IE 8]>
            <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
        <![endif]-->
    <div class="jumbotron">
		<div class="container-fluid">
		  <div class="playarea col-sm-8">
			  <div class="sequences">
				  <div class="sequence" onclick="restartGame('genome1')">
					  <div class="image"><img src="img/tomato.png"/></div>
					  <div class="code"></div>
				  </div>
				  <br>
				  <div class="sequence" onclick="restartGame('genome2')">
					  <div class="image"><img src="img/banana.png"/></div>
					  <div class="code"></div>
				  </div>
			  </div>
			  <div class="cols">
				  <div class="col-a">
					  <div class="hit-a hit-box" onclick="handleKeypress('A')">A</div>
				  </div>
				  <div class="col-t">
				  	  <div class="hit-t hit-box" onclick="handleKeypress('T')">T</div>
			  	  </div>
				  <div class="col-g">
					  <div class="hit-g hit-box" onclick="handleKeypress('G')">G</div>
				  </div>
				  <div class="col-c">
				  	  <div class="hit-c hit-box" onclick="handleKeypress('C')">C</div>
				  </div>
			  </div>
		  </div>
		  <div class="sidebar col-sm-4">
			  <div class="title">
				  <h1><img src="img/DNACE-Logo.png"/></h1>
			  </div>
			  <div class="message">
				  Ready to sequence
			  </div>
		  	  <div class="score">
	  	  		  <div class="misses">
					  <div class="block inactive"></div>
					  <div class="block inactive"></div>
					  <div class="block inactive"></div>
					  <div class="block inactive"></div>
					  <div class="block inactive"></div>
					  <div class="block inactive"></div>
				  </div>
				  <div class="numbers">0</div>
				  <div class="code">
				  </div>
		  	  </div>
			  <div class="controls">
				  <button class="restart" onclick="restartGame('genome1')">Restart</button>
			  </div>
		  </div>
  		</div>
    </div>
		<!-- /container -->
    </body>
</html>
